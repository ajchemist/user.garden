dist: trusty
language: java


jdk:
  - openjdk11
  - openjdk8
  # - oraclejdk11
  # - oraclejdk8


env:
  matrix:
    - TESTOPT="-R:1.9 -A:provided:test:test-runner"
    - TESTOPT="-R:1.10 -A:provided:test:test-runner"
    - TESTOPT="-R:1.9 -A:provided:test:eastwood"
    - TESTOPT="-R:1.10 -A:provided:test:eastwood"
    - TESTOPT="-R:1.9 -A:provided:test:cljs-test-runner"
    - TESTOPT="-R:1.10 -A:provided:test:cljs-test-runner"


install:
  - install_script=linux-install-1.10.1.536.sh
  - curl -LO https://download.clojure.org/install/$install_script
  - chmod +x $install_script
  - sudo ./$install_script
  - rm $install_script
  - export PATH=/usr/local/bin:$PATH
  - which gpg
  - which mvn
  - cp .ci/settings.xml $HOME/.m2/


cache:
  directories:
    - $HOME/.m2
    - $HOME/.gitlibs


script: clojure $TESTOPT


jobs:
  include:
    - stage: package
      jdk: openjdk11
      env: TESTOPT=""
      script: clojure -A:provided:test -m user.tools.deps.script.package -r user.garden
      before_cache:
        - mvn dependency:get -Dartifact=org.apache.maven.plugins:maven-deploy-plugin:2.8
      after_success:
        - git config --local user.name "ajchemist"
        - git config --local user.email "1694505+aJchemist@users.noreply.github.com"
        - eval $(ssh-agent -s)
        - ssh-add <(openssl aes-256-cbc -K $encrypted_0f15a2619e0a_key -iv $encrypted_0f15a2619e0a_iv -in .ci/deploy-key.enc -d)
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - ssh-keyscan github.com >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts
        - git checkout master
        - git add -- pom.xml
        - git commit -m "$(clojure -A:provided:test -m user.apache.maven.script.get-pom-version) [ci skip]"
        - git remote add origin-ssh "git@github.com:user.garden"
        - git remote -v
        - git push -v -u origin-ssh master:refs/heads/master
      deploy:
        provider: script
        skip_cleanup: true
        on:
          branch: master
          jdk: openjdk11
        script: mvn deploy:deploy-file -Dclojars.username="$CLOJARS_USERNAME" -Dclojars.password="$CLOJARS_PASSWORD" -DpomFile="pom.xml" -Dfile="target/package.jar" -Dpackaging=jar -DrepositoryId="clojars" -Durl="https://clojars.org/repo"


notifications:
  slack:
    rooms:
      - secure: "cNmDTb98PWg6bvCQULluV5PunDI8Hv5bSbhYViKwtZyokBwYc/ngvTQoRAD+2XgXbmWo2++e6WeXXOYWEJpBvdcXyAtv8jtrMfnas5G0gqxdf/Fc3GBhUJGQ3pWJjq5qLdrVz9/e+DD4sYgHjPP7zIFB/FkPLDve9dP7OBGJ8oLNkPJm+beCqxUkuBtn8lmScP2CCKQlW9D1PeTRASfXMZJoe7tiWU+pK36alYk9BDYNEO6oq9RZGwl5R8o7u0JQn7+zjzSt/jX70/6QG2w1mxL5XCxU6dn50HZ53DAaudJpAwy5R8Kywdil4VvZ9dm1o8wq/ymoEzB9XuBkeHiECsvyxdR+YZHVmAISPe5iXqCt3tZkqL8Y4JI1ZyeNTnBSr0jXhTDO3FyePBMrNL8zqDxjyLCVEuKbn7vO+RPjs5x4ekRudUcvqoEJ1nUucHp1zRX9MOqMS4l9/4d6lcPH3hMYjrI+2dFrsBZP8bgx0eH6g5cAJ7kDBnHjZo4ifRL9MVldDfrpn+StDRthwRX5EXtCV8z/d5ne+v12oLugHhmssS7rCnjxgDdzUNfBkdOdZaIfKeeCkKovmmFyr6kwFXOmv+bSDbcAFKNV9uEW75MuDwO/FCwBY01NA1J4LTujSwFoFIUuTln241p/xMd1Xpp/P9Wv8H4eXTza8RlbiE0="
    on_success: always
    on_failure: always
